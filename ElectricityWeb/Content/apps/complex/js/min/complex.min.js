var Tools;(function(t){var e=function(){function t(t,e){this.width=t,this.height=e}return t}();t.Size=e;var n=function(){function t(t,e){this.x=t,this.y=e}return t}();t.Position=n;var o=function(){function t(){this.objects=[]}return t.prototype.add=function(){for(var t=this,e=[],n=0;arguments.length>n;n++)e[n-0]=arguments[n];e.forEach(function(e){return t.objects.push(e)})},t.prototype.remove=function(t){var e=this.objects.indexOf(t);void 0!=e&&this.objects.splice(e,1)},Object.defineProperty(t.prototype,"all",{get:function(){return this.objects},enumerable:!0,configurable:!0}),t}(),i=function(){function t(t){this.storage=new o,this.canvas=t}return t.prototype.add=function(){for(var t=this,e=[],n=0;arguments.length>n;n++)e[n-0]=arguments[n];var o=this.canvas;e.forEach(function(e){t.storage.add(e),o.add(e.canvasObject),e.sendBack&&o.sendToBack(e.canvasObject)})},t.prototype.remove=function(t){this.storage.remove(t),this.canvas.remove(t.canvasObject),t.onRemove()},t.prototype.all=function(){var t=this.storage.all.filter(function(t){var e=t;return null!=e});return t.map(function(t){return t})},t}();t.CanvasObjects=i})(Tools||(Tools={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);n.prototype=e.prototype,t.prototype=new n},Visual;(function(t){var e=Tools.Size,n=function(){function t(){}return Object.defineProperty(t.prototype,"canvasObject",{get:function(){return this.object},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sendBack",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype.delete=function(){Application.instance.elements.remove(this)},t.prototype.onRemove=function(){},t.prototype.init=function(t,e){this.object=t,t.selectable=e||!1,t.hasBorders=!1,t.hasControls=!1,t.hasRotatingPoint=!1},t}();t.VisualElement=n;var o=function(t){function e(){t.apply(this,arguments),this.connections=[]}return __extends(e,t),Object.defineProperty(e.prototype,"x",{get:function(){return this.canvasObject.left+this.canvasObject.width*this.canvasObject.scaleX/2},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.canvasObject.top+this.canvasObject.height*this.canvasObject.scaleY/2},enumerable:!0,configurable:!0}),e.prototype.initSizable=function(e,n,o,i,r,c){e.left=n.x,e.top=n.y,e.width=o.width,e.height=o.height,e.fill=r||"grey",e.stroke=inactiveFigure.stroke,e.strokeWidth=c||0,e.setShadow({color:"rgba(0, 0, 0, 0.15)",offsetX:4,offsetY:4});var a=this;e.on("mousedown",function(){return a.onClick()}),t.prototype.init.call(this,e,i)},e.prototype.onClick=function(){Application.instance.toolbar.activeTool.clickHandler.onElementClick(this)},e.prototype.onRemove=function(){this.connections.forEach(function(t){return t.delete()})},e.prototype.connectWith=function(t){if(this.isConnectedWith(t))return null;var e=(new a).initLine(this,t,!1,"grey");return this.setConnection(e),t.setConnection(e),e},e.prototype.isConnectedWith=function(t){var e=!1;return this.connections.forEach(function(n){n.contains(t)&&(e=!0)}),e},e.prototype.setConnection=function(t){var e=this;this.connections.push(t);var n=function(){e.connections.forEach(function(t){t.updateNode(e)})};this.canvasObject.on({moving:n,scaling:n})},Object.defineProperty(e.prototype,"selected",{set:function(t){var e=Application.instance.canvas;this.canvasObject.set(t?activeFigure:inactiveFigure),e.renderAll()},enumerable:!0,configurable:!0}),e}(n);t.SizableElement=o;var i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.initRect=function(e,n,o,i){var r=new fabric.Rect;return t.prototype.initSizable.call(this,r,e,n,o,i,3),this},e}(o);t.RectElement=i;var r=function(t){function n(){t.apply(this,arguments)}return __extends(n,t),n.prototype.initCircle=function(n,o,i,r){var c=new fabric.Circle;return c.radius=o,t.prototype.initSizable.call(this,c,n,new e(o,o),i,r),this},n}(o);t.CircleElement=r;var c=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.initImage=function(t,e,n,o){var i=this;return fabric.Image.fromURL(n,function(n){i.initSizable(n,t,e,o,"white")}),this},e}(o);t.ImageElement=c;var a=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.initLine=function(e,n,o,i,r){void 0===r&&(r=1),this.from=e,this.to=n;var c=new fabric.Line([e.x,e.y,n.x,n.y]);return c.strokeWidth=r,c.stroke=i,t.prototype.init.call(this,c,o),this.line=c,this},e.prototype.updateNode=function(t){t===this.from&&this.line.set({x1:this.from.x,y1:this.from.y}),t===this.to&&this.line.set({x2:this.to.x,y2:this.to.y})},e.prototype.contains=function(t){return this.from===t||this.to===t},Object.defineProperty(e.prototype,"sendBack",{get:function(){return!0},enumerable:!0,configurable:!0}),e}(n);t.ConnectingLine=a,function(){function t(t,e){var n=new fabric.Text("Value",{fontSize:14});n.left=e.canvasObject.left,n.top=e.canvasObject.top;var o=new fabric.Group([e.canvasObject,n]);t.add(o)}return t}()})(Visual||(Visual={}));var inactiveBorder={stroke:"#eee",strokeWidth:2},activeBorder={stroke:"green",strokeWidth:3},inactiveConnection={stroke:"grey",strokeWidth:2},activeConnection={stroke:"grey",strokeWidth:3},inactiveFigure={stroke:"#ddd",strokeWidth:0},activeFigure={stroke:"#050",strokeWidth:3},Ui;(function(t){var e=function(){function t(t,e){for(var n=this,o=[],i=2;arguments.length>i;i++)o[i-2]=arguments[i];this.offset=3,this.controls=[],this.position=t,this.controlSize=e,o.forEach(function(t){return n.createToggle(t)})}return t.prototype.createToggle=function(t){var e=new n,o=this.controls.length*(this.controlSize.width+this.offset);e.initToggle(this,new Tools.Position(this.position.x+o,this.position.y),this.controlSize,t),this.controls.push(e)},t.prototype.onControlClicked=function(t){var e=this;this.controls.forEach(function(n){n.changeState(n===t),n===t&&(e.activeTool=n)})},t}();t.Toolbar=e;var n=function(){function t(){}return t.prototype.initToggle=function(t,e,n,o){var i=this;this.toolbar=t,this.size=n,this.tool=o;var r=function(){return i.onClick(i)};fabric.Image.fromURL(o.imgUrl,function(t){t.width=n.width,t.height=n.height,t.left=e.x,t.top=e.y,t.selectable=!1,t.on("mousedown",r),i.object=t,i.changeState(!1),Application.instance.canvas.add(t)})},t.prototype.onClick=function(t){t.toolbar.onControlClicked(t)},t.prototype.changeState=function(t){this.object.set(t?activeBorder:inactiveBorder)},Object.defineProperty(t.prototype,"clickHandler",{get:function(){return this.tool},enumerable:!0,configurable:!0}),t}()})(Ui||(Ui={}));var Ui;(function(t){var e=function(){function t(){}return t.prototype.onElementClick=function(t){Application.instance.deselect(),t.selected=!0},Object.defineProperty(t.prototype,"imgUrl",{get:function(){return"../Content/apps/complex/img/select.png"},enumerable:!0,configurable:!0}),t}();t.SelectTool=e;var n=function(){function t(){}return t.prototype.onElementClick=function(t){t.delete()},Object.defineProperty(t.prototype,"imgUrl",{get:function(){return"../Content/apps/complex/img/delete.svg"},enumerable:!0,configurable:!0}),t}();t.DeleteTool=n;var o=function(){function t(){}return t.prototype.onElementClick=function(t){if(null==this.saved)return this.saved=t,void 0;if(!this.saved.isConnectedWith(t)){var e=this.saved.connectWith(t);Application.instance.elements.add(e)}},Object.defineProperty(t.prototype,"imgUrl",{get:function(){return"../Content/apps/complex/img/connect.svg"},enumerable:!0,configurable:!0}),t}();t.ConnectTool=o})(Ui||(Ui={}));var Application=function(){function t(){this.canvas=new fabric.Canvas("canvas"),this.elements=new Tools.CanvasObjects(this.canvas)}return Object.defineProperty(t,"instance",{get:function(){return null==this.instanceInternal&&(this.instanceInternal=new t),this.instanceInternal},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=(new Visual.RectElement).initRect(new Tools.Position(100,200),new Tools.Size(200,100),!0,"#eee"),e=(new Visual.CircleElement).initCircle(new Tools.Position(400,100),20,!1);this.elements.add(t,e);var n=new Ui.Toolbar(new Tools.Position(0,0),new Tools.Size(80,80),new Ui.SelectTool,new Ui.DeleteTool,new Ui.ConnectTool);this.toolbar=n},t.prototype.clear=function(){this.canvas.clear()},t.prototype.deselect=function(){this.elements.all().forEach(function(t){return t.selected=!1})},t}();Application.instance.init();var creator;(function(t){var e=function(){function t(t){this.canvas=t,this.interactable=!0}return t}();t.creator=e;var n=function(t){function e(e){t.call(this,e),this.interactable=!1}return __extends(e,t),e}(e);t.staticContentCreator=n})(creator||(creator={}));